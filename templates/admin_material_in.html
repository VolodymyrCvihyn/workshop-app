{% extends "base.html" %}

{% block title %}Прихід матеріалу{% endblock %}

{% block content %}
<h1>Прихід матеріалу (розподіл по ємностях)</h1>

<div class="card">
    <h2 style="margin-top:0;">Вибір матеріалу</h2>
    <form method="get" id="material-form">
        <label>Пошук матеріалу</label><br>
        <input type="text" id="material_search"
               placeholder="Почніть вводити код або назву"
               style="min-width:260px; margin-bottom:6px;">
        <br>
        <label>Матеріал</label><br>
        <select name="material_id" onchange="this.form.submit()" id="material_select">
            <option value="">Оберіть матеріал</option>
            {% for m in materials %}
                <option value="{{ m.id }}"
                        {% if selected_material and selected_material.id == m.id %}selected{% endif %}>
                    {{ m.code }} – {{ m.name }} ({{ m.unit }})
                </option>
            {% endfor %}
        </select>
    </form>
    <p class="muted" style="margin-top:8px;">
        В полі вище можна ввести перші символи коду або назви — список матеріалів автоматично скоротиться.
    </p>
</div>

{% if selected_material %}
    <div class="card">
        <h2 style="margin-top:0;">Матеріал: {{ selected_material.code }} – {{ selected_material.name }}</h2>
        <p>
            Одиниця виміру: <strong>{{ selected_material.unit }}</strong><br>
            Поточний загальний залишок:
            {% if material_balance %}
                <strong>{{ '%.3f'|format(material_balance.balance|float) }} {{ selected_material.unit }}</strong>
            {% else %}
                <strong>0</strong> {{ selected_material.unit }}
            {% endif %}
        </p>
    </div>

    <div class="card">
        <h2 style="margin-top:0;">Розподіл приходу між ємностями</h2>

        {% if not containers %}
            <p class="muted">
                Для цього матеріалу немає жодної ємності.
                Створіть їх на сторінці
                <a href="{{ url_for('admin_containers', material_id=selected_material.id) }}">Ємності</a>.
            </p>
        {% else %}
            <form method="post">
                <input type="hidden" name="material_id" value="{{ selected_material.id }}">
                <div style="margin-bottom:8px;">
                    <label>Замовлення / робота (опціонально)</label><br>
                    <input type="text" name="job" style="width:100%;" placeholder="Номер замовлення, зміна тощо">
                </div>

                <p class="muted">
                    Введіть кількість, яка приходить у кожну ємність. Порожні поля будуть пропущені.
                </p>

                <div style="overflow-x:auto; margin-top:8px;">
                    <table>
                        <thead>
                        <tr>
                            <th>ID ємності</th>
                            <th>Локація</th>
                            <th>Поточний залишок</th>
                            <th>Додати ({{ selected_material.unit }})</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for c in containers %}
                            <tr>
                                <td>{{ c.id }}</td>
                                <td>{{ c.location_name }}</td>
                                <td>{{ '%.3f'|format(c.balance|float) }}</td>
                                <td>
                                    <input type="text" name="qty_{{ c.id }}" placeholder="0">
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div style="margin-top:12px;">
                    <button class="btn btn-primary" type="submit">Зберегти прихід</button>
                </div>
            </form>
        {% endif %}
    </div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
    var input = document.getElementById("material_search");
    var select = document.getElementById("material_select");
    if (!input || !select) return;
    input.addEventListener("input", function() {
        var q = input.value.toLowerCase();
        for (var i = 0; i < select.options.length; i++) {
            var opt = select.options[i];
            if (!opt.value) {
                opt.hidden = false;
                continue;
            }
            var text = opt.text.toLowerCase();
            opt.hidden = text.indexOf(q) === -1;
        }
    });
});
</script>
{% endblock %}
