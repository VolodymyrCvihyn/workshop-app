{% extends "base.html" %}

{% block title %}Ємності{% endblock %}

{% block content %}
<h1>Ємності</h1>

<div class="card">
    <h2 style="margin-top:0;">Фільтр</h2>
    <form method="get" class="toolbar">
        <div>
            <label>Локація</label><br>
            <select name="location_id" onchange="this.form.submit()">
                <option value="">(усі)</option>
                {% for loc in locations %}
                    <option value="{{ loc.id }}"
                        {% if selected_location_id == loc.id %}selected{% endif %}>
                        {{ loc.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Матеріал</label><br>
            <select name="material_id" onchange="this.form.submit()">
                <option value="">(усі)</option>
                {% for m in materials %}
                    <option value="{{ m.id }}"
                        {% if selected_material_id == m.id %}selected{% endif %}>
                        {{ m.code }} – {{ m.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>Пошук</label><br>
            <input type="text" name="q" value="{{ search_q or '' }}" placeholder="код, назва, локація">
            <button class="btn btn-secondary btn-sm" type="submit">Застосувати</button>
        </div>
        <div class="toolbar-right">
            <a class="btn btn-secondary btn-sm" href="{{ url_for('print_qr') }}">
                Пакетний друк QR-кодів
            </a>
        </div>
    </form>
</div>

<div class="card">
    <h2 style="margin-top:0;">Додати ємність</h2>
    <form method="post">
        <input type="hidden" name="action" value="add">
        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end;">
            <div>
                <label>Матеріал</label><br>
                <select name="material_id" required>
                    <option value="">Оберіть матеріал</option>
                    {% for m in materials %}
                        <option value="{{ m.id }}">{{ m.code }} – {{ m.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Локація</label><br>
                <select name="location_id" required>
                    <option value="">Оберіть локацію</option>
                    {% for loc in locations %}
                        <option value="{{ loc.id }}">{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Мінімальний залишок (необовʼязково)</label><br>
                <input type="text" name="min_balance" placeholder="наприклад, 5.0">
            </div>
            <div>
                <button class="btn btn-primary" type="submit">Додати ємність</button>
            </div>
        </div>
        <p class="muted" style="margin-top:8px;">
            QR-код буде згенеровано автоматично. Ви зможете надрукувати його для наклейки.
        </p>
    </form>
</div>

<div class="card">
    <h2 style="margin-top:0;">Список ємностей</h2>

    {% if not containers %}
        <p class="muted">За вибраним фільтром ємностей немає.</p>
    {% else %}
        <div style="overflow-x:auto;">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Матеріал</th>
                    <th>Локація</th>
                    <th>Залишок</th>
                    <th>Мін. залишок</th>
                    <th>QR</th>
                    <th>Дії</th>
                </tr>
                </thead>
                <tbody>
                {% for c in containers %}
                    <tr class="{% if c.min_balance is not none and c.balance < c.min_balance %}low-stock{% endif %}">
                        <td>{{ c.id }}</td>
                        <td>
                            {{ c.material_code }} – {{ c.material_name }}
                            <div class="muted">{{ c.material_unit }}</div>
                        </td>
                        <td>
                            <!-- Оновлення локації -->
                            <form method="post" class="inline" style="margin:0;">
                                <input type="hidden" name="action" value="update_location">
                                <input type="hidden" name="container_id" value="{{ c.id }}">
                                <select name="location_id" onchange="this.form.submit()">
                                    {% for loc in locations %}
                                        <option value="{{ loc.id }}"
                                            {% if loc.id == c.location_id %}selected{% endif %}>
                                            {{ loc.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>
                        <td>{{ '%.3f'|format(c.balance|float) }}</td>
                        <td>
                            <!-- Оновлення мін. залишку -->
                            <form method="post" class="inline" style="margin:0;">
                                <input type="hidden" name="action" value="update_min">
                                <input type="hidden" name="container_id" value="{{ c.id }}">
                                <input type="text" name="min_balance"
                                       value="{% if c.min_balance is not none %}{{ '%.3f'|format(c.min_balance|float) }}{% endif %}"
                                       style="width:80px;">
                                <button class="btn btn-secondary btn-sm" type="submit">OK</button>
                            </form>
                        </td>
                        <td>
                            <a href="{{ url_for('container_qr', container_id=c.id) }}" target="_blank"
                               class="btn btn-secondary btn-sm">
                                QR-код
                            </a>
                        </td>
                        <td>
                            <a class="btn btn-secondary btn-sm"
                               href="{{ url_for('container_history', container_id=c.id) }}">
                                Історія
                            </a>
                            <form method="post"
                                  class="inline"
                                  action="{{ url_for('delete_container', container_id=c.id) }}"
                                  onsubmit="return confirm('Видалити цю ємність і всі повʼязані операції?');">
                                <button class="btn btn-danger btn-sm" type="submit">Видалити</button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>
{% endblock %}
