{% extends "base.html" %}

{% block title %}–Ñ–º–Ω–æ—Å—Ç—ñ{% endblock %}

{% block content %}
<h1>–Ñ–º–Ω–æ—Å—Ç—ñ</h1>

<div class="card">
    <h2>–§—ñ–ª—å—Ç—Ä</h2>
    <form method="get" class="toolbar">
        <div>
            <label>–õ–æ–∫–∞—Ü—ñ—è</label><br>
            <select name="location_id">
                <option value="">(—É—Å—ñ)</option>
                {% for loc in locations %}
                    <option value="{{ loc.id }}"
                        {% if selected_location_id == loc.id %}selected{% endif %}>
                        {{ loc.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>–ú–∞—Ç–µ—Ä—ñ–∞–ª</label><br>
            <select name="material_id">
                <option value="">(—É—Å—ñ)</option>
                {% for m in materials %}
                    <option value="{{ m.id }}"
                        {% if selected_material_id == m.id %}selected{% endif %}>
                        {{ m.code }} ‚Äì {{ m.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>–ü–æ—à—É–∫</label><br>
            <input type="text" name="q" placeholder="–∫–æ–¥, –Ω–∞–∑–≤–∞, –ª–æ–∫–∞—Ü—ñ—è" value="{{ search_q or '' }}">
        </div>
        <div class="toolbar-right">
            <button class="btn btn-secondary btn-sm" type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
            {% if selected_location_id %}
                <a class="btn btn-secondary btn-sm"
                   href="{{ url_for('print_qr', location_id=selected_location_id) }}">
                    üñ® –ü–∞–∫–µ—Ç–Ω–∏–π –¥—Ä—É–∫ QR-–∫–æ–¥—ñ–≤
                </a>
            {% endif %}
        </div>
    </form>
</div>

<div class="card">
    <h2>–î–æ–¥–∞—Ç–∏ —î–º–Ω—ñ—Å—Ç—å</h2>
    <p class="muted">
        QR-–∫–æ–¥ –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –í–∏ –∑–º–æ–∂–µ—Ç–µ –Ω–∞–¥—Ä—É–∫—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è –Ω–∞–∫–ª–µ–π–∫–∏.
    </p>
    <form method="post" class="toolbar">
        <input type="hidden" name="action" value="add">
        <div>
            <label>–ú–∞—Ç–µ—Ä—ñ–∞–ª</label><br>
            <select name="material_id" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª</option>
                {% for m in materials %}
                    <option value="{{ m.id }}">{{ m.code }} ‚Äì {{ m.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>–õ–æ–∫–∞—Ü—ñ—è</label><br>
            <select name="location_id" required>
                <option value="">–û–±–µ—Ä—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é</option>
                {% for loc in locations %}
                    <option value="{{ loc.id }}">{{ loc.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label>–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ª–∏—à–æ–∫ (–Ω–µ–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ)</label><br>
            <input type="text" name="min_balance" placeholder="–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 5.0">
        </div>
        <div class="toolbar-right">
            <button type="submit" class="btn btn-primary btn-big">–î–æ–¥–∞—Ç–∏ —î–º–Ω—ñ—Å—Ç—å</button>
        </div>
    </form>
</div>

<div class="card">
    <h2>–°–ø–∏—Å–æ–∫ —î–º–Ω–æ—Å—Ç–µ–π</h2>
    {% if not containers %}
        <p class="muted">–Ñ–º–Ω–æ—Å—Ç–µ–π –∑–∞ –ø–æ—Ç–æ—á–Ω–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º –Ω–µ–º–∞—î.</p>
    {% else %}
        {% set low_count = 0 %}
        {% for c in containers %}
            {% if c.min_balance is not none and c.balance < c.min_balance %}
                {% set low_count = low_count + 1 %}
            {% endif %}
        {% endfor %}
        <p class="muted" style="margin-bottom:8px;">
            –í—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: {{ containers|length }} —î–º–Ω–æ—Å—Ç–µ–π,
            –∑ –Ω–∏—Ö –∑ –Ω–∏–∑—å–∫–∏–º –∑–∞–ª–∏—à–∫–æ–º: {{ low_count }}.
        </p>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>–ú–∞—Ç–µ—Ä—ñ–∞–ª</th>
                    <th>–õ–æ–∫–∞—Ü—ñ—è</th>
                    <th class="num">–ó–∞–ª–∏—à–æ–∫</th>
                    <th class="num">–ú—ñ–Ω. –∑–∞–ª–∏—à–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>QR</th>
                    <th>–î—ñ—ó</th>
                </tr>
                </thead>
                <tbody>
                {% for c in containers %}
                    {% set status_class = 'badge-soft' %}
                    {% set status_text = '–ù–µ –Ω–∞–ª–∞—à—Ç.' %}
                    {% set title = '' %}
                    {% if c.min_balance is not none %}
                        {% set title = '–ü–æ—Ç–æ—á–Ω–∏–π: ' ~ ('%.3f'|format(c.balance|float)) ~ ' / –º—ñ–Ω—ñ–º—É–º: ' ~ ('%.3f'|format(c.min_balance|float)) %}
                        {% if c.balance < c.min_balance %}
                            {% set status_class = 'badge badge-danger' %}
                            {% set status_text = '–ù–∏–∑—å–∫–æ' %}
                        {% elif c.balance < c.min_balance * 1.2 %}
                            {% set status_class = 'badge badge-warn' %}
                            {% set status_text = '–ú–∞–ª–æ' %}
                        {% else %}
                            {% set status_class = 'badge badge-ok' %}
                            {% set status_text = 'OK' %}
                        {% endif %}
                    {% endif %}
                    <tr class="{% if c.min_balance is not none and c.balance < c.min_balance %}low-stock{% endif %}">
                        <td>{{ c.id }}</td>
                        <td>
                            {{ c.material_code }} ‚Äì {{ c.material_name }}<br>
                            <span class="muted">{{ c.material_unit }}</span>
                        </td>
                        <td>
                            <form method="post" class="inline">
                                <input type="hidden" name="action" value="update_location">
                                <input type="hidden" name="container_id" value="{{ c.id }}">
                                <select name="location_id" onchange="this.form.submit()">
                                    {% for loc in locations %}
                                        <option value="{{ loc.id }}"
                                            {% if loc.id == c.location_id %}selected{% endif %}>
                                            {{ loc.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </td>
                        <td class="num">{{ '%.3f'|format(c.balance|float) }}</td>
                        <td class="num">
                            <form method="post" class="inline">
                                <input type="hidden" name="action" value="update_min">
                                <input type="hidden" name="container_id" value="{{ c.id }}">
                                <input type="text" name="min_balance"
                                       value="{% if c.min_balance is not none %}{{ '%.3f'|format(c.min_balance|float) }}{% endif %}"
                                       style="width:90px;">
                                <button type="submit" class="btn btn-secondary btn-sm">OK</button>
                            </form>
                        </td>
                        <td>
                            <span class="{{ status_class }}" title="{{ title }}">
                                {{ status_text }}
                            </span>
                        </td>
                        <td>
                            <a class="btn btn-secondary btn-sm"
                               href="{{ url_for('container_qr', container_id=c.id) }}"
                               target="_blank">
                                ‚¨õ QR-–∫–æ–¥
                            </a>
                        </td>
                        <td>
                            <a class="btn btn-secondary btn-sm"
                               href="{{ url_for('container_history', container_id=c.id) }}">
                                üïì –Ü—Å—Ç–æ—Ä—ñ—è
                            </a>
                            <form method="post"
                                  class="inline"
                                  action="{{ url_for('delete_container', container_id=c.id) }}">
                                <button type="submit"
                                        class="btn btn-danger btn-sm"
                                        data-confirm="–í–∏–¥–∞–ª–∏—Ç–∏ —î–º–Ω—ñ—Å—Ç—å —Ç–∞ –≤—Å—ñ —ó—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó?">
                                    üóë –í–∏–¥–∞–ª–∏—Ç–∏
                                </button>
                            </form>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}
</div>
{% endblock %}
